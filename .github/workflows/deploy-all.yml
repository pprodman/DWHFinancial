name: 'Deploy: Full Stack'

on:
  workflow_dispatch:
    inputs:
      deploy_ingestion:
        description: 'Deploy ingestion function'
        type: boolean
        default: true
      deploy_dbt:
        description: 'Deploy dbt job'
        type: boolean
        default: true
      deploy_trigger:
        description: 'Deploy trigger function'
        type: boolean
        default: true
      run_after_deploy:
        description: 'Run pipeline after deployment'
        type: boolean
        default: false

jobs:
  deploy-ingestion:
    name: 'Deploy Ingestion'
    if: ${{ inputs.deploy_ingestion }}
    uses: ./.github/workflows/deploy-ingestion.yml
    secrets: inherit
  
  deploy-dbt:
    name: 'Deploy dbt'
    if: ${{ inputs.deploy_dbt }}
    uses: ./.github/workflows/deploy-dbt.yml
    secrets: inherit
  
  deploy-trigger:
    name: 'Deploy Trigger'
    if: ${{ inputs.deploy_trigger }}
    needs: deploy-dbt
    uses: ./.github/workflows/deploy-trigger.yml
    secrets: inherit
  
  run-pipeline:
    name: 'Execute Pipeline'
    if: ${{ inputs.run_after_deploy }}
    needs: [deploy-ingestion, deploy-dbt, deploy-trigger]
    uses: ./.github/workflows/run-pipeline.yml
    secrets: inherit