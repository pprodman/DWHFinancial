name: 'Schedule: Daily Pipeline'

on:
  schedule:
    # Ejecutar diariamente a las 8:00 AM Madrid (7:00 UTC)
    - cron: '0 7 * * *'
  workflow_dispatch:

env:
  PROJECT_ID: 'dwhfinancial'
  PUB_SUB_TOPIC: 'run-ingestion-pipeline'

jobs:
  trigger-daily:
    name: 'Daily Pipeline Execution'
    runs-on: ubuntu-latest
    
    permissions:
      contents: 'read'
      id-token: 'write'
    
    steps:
      - name: 'Authenticate to GCP'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: 'github-actions-deployer@dwhfinancial.iam.gserviceaccount.com'
      
      - name: 'Set up gcloud CLI'
        uses: 'google-github-actions/setup-gcloud@v2'
      
      - name: 'Trigger daily ingestion'
        run: |
          echo "üìÖ Daily scheduled run - $(date)"
          gcloud pubsub topics publish ${{ env.PUB_SUB_TOPIC }} \
            --project=${{ env.PROJECT_ID }} \
            --message='{"scheduled": true, "source": "github-actions-cron", "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}'
          echo "‚úÖ Daily pipeline triggered!"
      
      - name: 'Send notification'
        if: failure()
        run: |
          echo "‚ö†Ô∏è Daily pipeline trigger failed!"
          # Aqu√≠ podr√≠as a√±adir notificaci√≥n por email/Slack