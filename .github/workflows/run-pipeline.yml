name: 'Run: Execute Pipeline'

on:
  workflow_dispatch:
    inputs:
      full_refresh:
        description: 'Run dbt with --full-refresh'
        type: boolean
        default: false
      reason:
        description: 'Reason for manual run'
        type: string
        required: false
        default: 'Manual execution from GitHub Actions'
  workflow_call:

env:
  PROJECT_ID: 'dwhfinancial'
  PUB_SUB_TOPIC: 'run-ingestion-pipeline'

jobs:
  trigger-pipeline:
    name: 'Trigger Pipeline Execution'
    runs-on: ubuntu-latest
    
    permissions:
      contents: 'read'
      id-token: 'write'
    
    steps:
      - name: 'Authenticate to GCP'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: 'github-actions-deployer@dwhfinancial.iam.gserviceaccount.com'
      
      - name: 'Set up gcloud CLI'
        uses: 'google-github-actions/setup-gcloud@v2'
      
      - name: 'Prepare message'
        id: prepare
        run: |
          if [ "${{ inputs.full_refresh }}" = "true" ]; then
            message='{"full_refresh": true, "reason": "${{ inputs.reason }}"}'
          else
            message='{"full_refresh": false, "reason": "${{ inputs.reason }}"}'
          fi
          echo "message=$message" >> $GITHUB_OUTPUT
          echo "ğŸ“¨ Message: $message"
      
      - name: 'Publish message to Pub/Sub'
        run: |
          echo "ğŸš€ Triggering pipeline..."
          gcloud pubsub topics publish ${{ env.PUB_SUB_TOPIC }} \
            --project=${{ env.PROJECT_ID }} \
            --message='${{ steps.prepare.outputs.message }}'
          echo "âœ… Pipeline triggered successfully!"
      
      - name: 'Wait and monitor'
        run: |
          echo "â³ Pipeline is running in background..."
          echo "ğŸ“Š Monitor at: https://console.cloud.google.com/run/jobs/details/us-central1/dbt-transform-job"
          echo "ğŸ“ Logs at: https://console.cloud.google.com/logs"