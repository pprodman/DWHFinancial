# .github/workflows/deploy.yml

name: Deploy and Run Full Financial DWH

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PROJECT_ID: 'dwhfinancial'
  PROJECT_NUMBER: '675312276583'
  REGION: 'europe-west1'
  GCS_BUCKET: 'dwhfinancial-data-feed'
  DRIVE_SECRET_NAME: 'drive-service-account-key'
  TRIGGER_TOPIC: 'drive-check-topic'
  # --- Datasets por Capa ---
  BQ_DATASET_RAW: 'dwh_01_raw'
  BQ_DATASET_BRONZE: 'dwh_02_bronze'
  BQ_DATASET_SILVER: 'dwh_03_silver'
  BQ_DATASET_GOLD: 'dwh_04_gold'
  # --- Nombres de Tablas ---
  BQ_TABLE_TRANSACTIONS: 'transactions'
  BQ_TABLE_SUMMARY: 'monthly_summary'

jobs:
  deploy-and-run:
    name: Deploy Infrastructure and Run Transformations
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: 'google-github-actions/auth@v2'
      with:
        workload_identity_provider: 'projects/${{ env.PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
        service_account: 'github-actions-deployer@${{ env.PROJECT_ID }}.iam.gserviceaccount.com'

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Deploy Unified ETL (Drive to GCS)
      run: |
        gcloud functions deploy etl-drive-to-gcs --gen2 --runtime=python311 --region=${{ env.REGION }} --source=./cloud_functions/etl-drive-to-gcs --entry-point=main --trigger-topic=${{ env.TRIGGER_TOPIC }} --set-env-vars="GCP_PROJECT=${{ env.PROJECT_ID }},BUCKET_NAME=${{ env.GCS_BUCKET }},DRIVE_SECRET_NAME=${{ env.DRIVE_SECRET_NAME }}"

    - name: Deploy GCS-to-BigQuery Function
      run: |
        gcloud functions deploy etl-gcs-to-bq --gen2 --runtime=python311 --region=${{ env.REGION }} --source=./cloud_functions/etl_gcs_to_bq --entry-point=main --trigger-event-filters="type=google.cloud.storage.object.v1.finalized,bucket=${{ env.GCS_BUCKET }}" --trigger-location=eu --set-env-vars="GCP_PROJECT=${{ env.PROJECT_ID }},BIGQUERY_DATASET=${{ env.BQ_DATASET_RAW }},BIGQUERY_TABLE_RAW=${{ env.BQ_TABLE_TRANSACTIONS }}"

    - name: Create BigQuery Datasets and Tables
      run: |
        echo "Creando datasets..."
        bq --location=${{ env.REGION }} mk --dataset --description "Capa RAW: Datos crudos" ${{ env.BQ_DATASET_RAW }} || echo "Dataset RAW ya existe."
        bq --location=${{ env.REGION }} mk --dataset --description "Capa BRONZE: Datos enriquecidos" ${{ env.BQ_DATASET_BRONZE }} || echo "Dataset BRONZE ya existe."
        bq --location=${{ env.REGION }} mk --dataset --description "Capa SILVER: Datos limpios y de negocio" ${{ env.BQ_DATASET_SILVER }} || echo "Dataset SILVER ya existe."
        bq --location=${{ env.REGION }} mk --dataset --description "Capa GOLD: Datos agregados para anal√≠tica" ${{ env.BQ_DATASET_GOLD }} || echo "Dataset GOLD ya existe."

        echo "Creando tablas..."
        bq mk --table --schema=schemas/A1_raw_to_bronze.json ${{ env.BQ_DATASET_RAW }}.${{ env.BQ_TABLE_TRANSACTIONS }} || echo "Tabla RAW ya existe."
        bq mk --table --schema=schemas/A2_bronze_to_silver.json ${{ env.BQ_DATASET_BRONZE }}.${{ env.BQ_TABLE_TRANSACTIONS }} || echo "Tabla BRONZE ya existe."
        bq mk --table --schema=schemas/A3_silver_to_gold.json ${{ env.BQ_DATASET_SILVER }}.${{ env.BQ_TABLE_TRANSACTIONS }} || echo "Tabla SILVER ya existe."

    - name: Run BigQuery Transformations
      run: |
        echo "--- Ejecutando 01_raw_to_bronze.sql ---"
        bq query --project_id=${{ env.PROJECT_ID }} --use_legacy_sql=false \
          --parameter=project_id:STRING:${{ env.PROJECT_ID }} \
          --parameter=raw_dataset:STRING:${{ env.BQ_DATASET_RAW }} \
          --parameter=bronze_dataset:STRING:${{ env.BQ_DATASET_BRONZE }} \
          --parameter=raw_table:STRING:${{ env.BQ_TABLE_TRANSACTIONS }} \
          --parameter=bronze_table:STRING:${{ env.BQ_TABLE_TRANSACTIONS }} \
          "$(cat queries/01_raw_to_bronze.sql)"

        echo "--- Ejecutando 02_bronze_to_silver.sql ---"
        bq query --project_id=${{ env.PROJECT_ID }} --use_legacy_sql=false \
          --parameter=project_id:STRING:${{ env.PROJECT_ID }} \
          --parameter=bronze_dataset:STRING:${{ env.BQ_DATASET_BRONZE }} \
          --parameter=silver_dataset:STRING:${{ env.BQ_DATASET_SILVER }} \
          --parameter=bronze_table:STRING:${{ env.BQ_TABLE_TRANSACTIONS }} \
          --parameter=silver_table:STRING:${{ env.BQ_TABLE_TRANSACTIONS }} \
          "$(cat queries/02_bronze_to_silver.sql)"

        echo "--- Ejecutando 03_silver_to_gold.sql ---"
        bq query --project_id=${{ env.PROJECT_ID }} --use_legacy_sql=false \
          --parameter=project_id:STRING:${{ env.PROJECT_ID }} \
          --parameter=silver_dataset:STRING:${{ env.BQ_DATASET_SILVER }} \
          --parameter=gold_dataset:STRING:${{ env.BQ_DATASET_GOLD }} \
          --parameter=silver_table:STRING:${{ env.BQ_TABLE_TRANSACTIONS }} \
          --parameter=gold_table:STRING:${{ env.BQ_TABLE_SUMMARY }} \
          "$(cat queries/03_silver_to_gold.sql)"