name: 'Finanzas Pipeline: Coste Cero'

on:
  schedule:
    - cron: '0 7 * * *' # 8:00 AM Madrid (7:00 UTC)
  workflow_dispatch:    # Ejecuci贸n manual desde la pesta帽a Actions

env:
  # Estas variables las usar谩 tu script ingestion_function/main.py
  # Aseg煤rate de que los nombres coinciden con lo que espera el script
  GCS_BUCKET_NAME: ${{ secrets.GCS_BUCKET_NAME }}
  DRIVE_PARENT_FOLDER_ID: ${{ secrets.DRIVE_PARENT_FOLDER_ID }}
  
  # Ruta temporal para la clave de servicio (necesaria para dbt y el script)
  GOOGLE_APPLICATION_CREDENTIALS: '/tmp/gcp_key.json'

jobs:
  run_data_pipeline:
    name: 'Run Ingestion & Transformation'
    runs-on: ubuntu-latest
    
    steps:
      # 1. Descargar tu c贸digo
      - name: ' Descargar repositorio'
        uses: actions/checkout@v4 # Actualizado a v4 (est谩ndar actual)

      # 2. Preparar Python 3.11 (Lo que pediste)
      - name: ' Configurar Python 3.11'
        uses: actions/setup-python@v5 # Actualizado a v5
        with:
          python-version: '3.11'
          cache: 'pip' # Esto acelera las instalaciones futuras

      # 3. Crear el archivo de credenciales desde el Secreto
      # Este paso es CRTICO: decodifica el secreto y crea el archivo f铆sico
      - name: ' Crear archivo de clave GCP'
        run: |
          echo '${{ secrets.GCP_SA_KEY }}' > /tmp/gcp_key.json

      # 4. Instalar librer铆as
      # He unificado las dependencias para asegurar que est茅n todas
      - name: ' Instalar Dependencias'
        run: |
          # Opci贸n A: Si tienes un requirements.txt en la ra铆z que incluye todo
          # pip install -r requirements.txt
          
          # Opci贸n B (M谩s segura ahora mismo): Instalar lo justo y necesario
          pip install pandas google-cloud-storage google-api-python-client google-auth openpyxl dbt-bigquery

      # 5. EJECUTAR SCRIPT INGESTA (Drive -> GCS)
      # Nota: Este script debe ser la versi贸n "aut贸noma" que te pas茅 antes
      - name: ' Ejecutar Ingesta (Python)'
        run: |
          python ingestion_function/main.py

      # 6. EJECUTAR DBT (BigQuery)
      # Importante: Entramos en la carpeta dbt_project antes de ejecutar
      - name: ' Ejecutar dbt'
        working-directory: ./dbt_project
        run: |
          dbt deps
          dbt seed
          dbt run --target prod
          # dbt test # Opcional: descomentar si tienes tests definidos