# .github/workflows/deploy-dbt-job.yml (VERSIÃ“N SIMPLIFICADA)

name: 'Deploy & Run: dbt Transformation Job'

on:
  push:
    branches: [ 'main' ]
    paths:
      - 'dbt_project/**'
      - '.github/workflows/deploy-dbt-job.yml'
  workflow_dispatch:

env:
  PROJECT_ID: 'dwhfinancial'
  REGION: 'us-central1'
  REPOSITORY: 'cloud-run-source-deploy' # Repositorio en Artifact Registry
  JOB_NAME: 'dbt-transform-job'
  # La SA del Job que se ejecuta en Cloud Run
  JOB_SERVICE_ACCOUNT: 'drive-reader-sa@dwhfinancial.iam.gserviceaccount.com' 
  # La SA que usa GitHub para desplegar
  DEPLOYER_SERVICE_ACCOUNT: 'github-actions-deployer@dwhfinancial.iam.gserviceaccount.com'

jobs:
  # Job 1: Construye y despliega la imagen en un solo paso
  build-and-deploy:
    name: 'Build and Deploy'
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    
    steps:
      - name: 'Checkout repository code'
        uses: actions/checkout@v4

      - name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.DEPLOYER_SERVICE_ACCOUNT }}

      - name: 'Set up gcloud CLI'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: 'Build and Deploy Job from Source'
        id: deploy
        run: |
          echo "ðŸš€ Building from source and deploying job: ${{ env.JOB_NAME }}"
          
          # Este comando hace todo el trabajo pesado
          gcloud run jobs deploy ${{ env.JOB_NAME }} \
            --project=${{ env.PROJECT_ID }} \
            --region=${{ env.REGION }} \
            --source=./dbt_project \
            --service-account=${{ env.JOB_SERVICE_ACCOUNT }} \
            --quiet
            
          echo "âœ… Job deployed successfully!"

  # Job 2 (Opcional): Ejecuta el Job despuÃ©s de un despliegue exitoso
  execute-job:
    name: 'Execute dbt Job'
    runs-on: ubuntu-latest
    needs: build-and-deploy
    
    if: |
      always() && needs.build-and-deploy.result == 'success' &&
      (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_job_after_deploy != 'false'))

    permissions:
      id-token: 'write'
      contents: 'read'

    steps:
      - name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.DEPLOYER_SERVICE_ACCOUNT }}

      - name: 'Set up gcloud CLI'
        uses: 'google-github-actions/setup-gcloud@v2'
        
      - name: 'Execute Cloud Run Job and Wait for Result'
        run: |
          echo "âš¡ Starting execution for job: ${{ env.JOB_NAME }}"
          gcloud run jobs execute ${{ env.JOB_NAME }} --wait --region=${{ env.REGION }}