# .github/workflows/deploy-dbt-job.yml

name: 'Deploy & Run: dbt Transformation Job'

on:
  push:
    branches: [ 'main' ]
    paths:
      - 'dbt_project/**'
      - 'trigger_dbt_function/**'  # ‚Üê ¬°Agregado!
      - '.github/workflows/deploy-dbt-job.yml'
  workflow_dispatch:

env:
  PROJECT_ID: 'dwhfinancial'
  REGION: 'us-central1'
  REPOSITORY: 'cloud-run-source-deploy'
  JOB_NAME: 'dbt-transform-job'
  JOB_SERVICE_ACCOUNT: 'drive-reader-sa@dwhfinancial.iam.gserviceaccount.com' 
  DEPLOYER_SERVICE_ACCOUNT: 'github-actions-deployer@dwhfinancial.iam.gserviceaccount.com'

jobs:
  # Job 1: Construye y despliega el job de dbt
  build-and-deploy:
    name: 'Build and Deploy'
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    
    steps:
      - name: 'Checkout repository code'
        uses: actions/checkout@v4

      - name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.DEPLOYER_SERVICE_ACCOUNT }}

      - name: 'Set up gcloud CLI'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: 'Build and Deploy Job from Source'
        id: deploy
        run: |
          echo "üöÄ Building from source and deploying job: ${{ env.JOB_NAME }}"
          gcloud run jobs deploy ${{ env.JOB_NAME }} \
            --project=${{ env.PROJECT_ID }} \
            --region=${{ env.REGION }} \
            --source=./dbt_project \
            --service-account=${{ env.JOB_SERVICE_ACCOUNT }} \
            --quiet
          echo "‚úÖ Job deployed successfully!"

  # Job 2: Despliega la funci√≥n de trigger (¬°nuevo!)
  deploy-trigger-function:
    name: 'Deploy GCS Trigger Function'
    runs-on: ubuntu-latest
    needs: build-and-deploy
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: 'Checkout repository code'
        uses: actions/checkout@v4

      - name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.DEPLOYER_SERVICE_ACCOUNT }}

      - name: 'Set up gcloud CLI'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: 'Deploy Cloud Function'
        run: |
          echo "üöÄ Deploying GCS trigger function..."
          gcloud functions deploy trigger-dbt-on-gcs \
            --runtime python311 \
            --trigger-bucket dwhfinancial-data-feed \
            --entry-point trigger_dbt_job \
            --source=./trigger_dbt_function \
            --set-env-vars PROJECT_ID=${{ env.PROJECT_ID }},REGION=${{ env.REGION }},JOB_NAME=${{ env.JOB_NAME }} \
            --service-account=${{ env.DEPLOYER_SERVICE_ACCOUNT }} \
            --quiet
          echo "‚úÖ Trigger function deployed!"

  # Job 3: Ejecuta el job manualmente (opcional)
  execute-job:
    name: 'Execute dbt Job'
    runs-on: ubuntu-latest
    needs: deploy-trigger-function
    
    if: |
      always() && needs.deploy-trigger-function.result == 'success' &&
      (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_job_after_deploy != 'false'))

    permissions:
      id-token: 'write'
      contents: 'read'

    steps:
      - name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.DEPLOYER_SERVICE_ACCOUNT }}

      - name: 'Set up gcloud CLI'
        uses: 'google-github-actions/setup-gcloud@v2'
        
      - name: 'Execute Cloud Run Job and Wait for Result'
        run: |
          echo "‚ö° Starting execution for job: ${{ env.JOB_NAME }}"
          gcloud run jobs execute ${{ env.JOB_NAME }} --wait --region=${{ env.REGION }}