name: Backup Repository to GCS

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_ID: 'dwhfinancial'
  GCS_BUCKET_REPO_BACKUP: 'dwhfinancial-repo-backup'

jobs:
  backup:
    name: Mirror Repository to GCS
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout del c칩digo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Autenticaci칩n unificada (Usando el mismo secreto que el pipeline diario)
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      # 3. Configurar SDK
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # 4. Sincronizar (Excluyendo la carpeta .git para ahorrar espacio y tiempo)
      - name: Sync repository to GCS bucket
        run: |
          echo "Sincronizando el repositorio con gs://${{ env.GCS_BUCKET_REPO_BACKUP }}..."
          # -m: multi-threading (m치s r치pido)
          # -d: delete (borra en GCS lo que ya no exista en local, espejo exacto)
          # -r: recursivo
          # -x: excluye la carpeta oculta .git
          gsutil -m rsync -d -r -x "^\.git/.*$" . gs://${{ env.GCS_BUCKET_REPO_BACKUP }}